<!DOCTYPE html>
<head>
<meta charset="UTF-8">
<html lang="en" data-theme="light"></html>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mscler</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="header-container">
    <div class="left-buttons">
      <button class="btn-success" onclick="toggleTrainingPlanForm()" id="toggleBtn">Show training</button>
      <button onclick="topFunction()" id="topbtn" title="Go to top">&uarr;</button>
    </div>
    <h1></h1>
    <div class="header-buttons">
      <button onclick="toggleTheme()" id="toggleMode">Dark mode</button>
    </div>
  </div>
  <br>
  <br>
  <br>
  <div class="flex" id="app">
      <div id="exer">
        <div class="card">
          <h2 id="musclegrp">Muscle groups</h2>
          <div class="form-group">
            <h3 id="category">Categorys</h3>
            <div id="categories" class="button-row"></div>
          </div>
          <div class="form-group" id="muscleGroupContainer" style="display:none">
            <h3>Specific muscle groups</h3>
            <div id="muscleGroups" class="button-row"></div>
          </div>
          <div class="form-group">
            <h3 id="devicefilter">Device filter</h3>
            <div id="equipment" class="button-row">
              <button onclick="filterByEquipment('')">All devices</button>
            </div>
          </div>
        </div>
      </div>

      <div id="trainingPlanForm" style="display:none">
        <div class="card" >
          <h2 id="create">Create training</h2>
          <div class="form-group">
            <h4 class="range-label" id="trainingdays">Training days in a week:</h4>
            <input type="range" min="1" max="6" value="3" id="daysRange" onload="updateDaysValue(this.value)" oninput="updateDaysValue(this.value)">
            <div class="range-value" id="daysValue">3 days</div>
          </div>
          <div class="form-group">
            <h4 class="range-label" id="available">Available equipment</h4>
            <div id="availableEquipment" class="button-row"></div>
          </div>
          <div class="advanced-wrapper">
            <div class="advanced-toggle">
              <h4 id="advanced-label">Advanced settings</h4>
              <button class="setting-btn">
                <span class="bar bar1"></span>
                <span class="bar bar2"></span>
                <span class="bar bar1"></span>
              </button>
            </div>
            <div class="advanced-content">
              <div class="form-group">
                <label class="range-label">Max exercises per muscle on a day</label>
                <div class="muscle-slider">
                  <label for="chest">Chest</label>
                  <input type="range" id="chest" min="0" max="5" value="2" onchange="updateValue(this)">
                  <span class="value">2</span>
                </div>
                <div class="muscle-slider">
                  <label for="shoulders">Shoulders</label>
                  <input type="range" id="shoulders" min="0" max="5" value="2" oninput="updateValue(this)">
                  <span class="value">2</span>
                </div>
                <div class="muscle-slider">
                  <label for="biceps">Biceps</label>
                  <input type="range" id="biceps" min="0" max="5" value="2" oninput="updateValue(this)">
                  <span class="value">2</span>
                </div>
                <div class="muscle-slider">
                  <label for="triceps">Triceps</label>
                  <input type="range" id="triceps" min="0" max="5" value="2" oninput="updateValue(this)">
                  <span class="value">2</span>
                </div>
                <div class="muscle-slider">
                  <label for="abs">Abs</label>
                  <input type="range" id="abs" min="0" max="5" value="1" oninput="updateValue(this)">
                  <span class="value">1</span>
                </div>
                <div class="muscle-slider">
                  <label for="back">Back</label>
                  <input type="range" id="back" min="0" max="5" value="3" oninput="updateValue(this)">
                  <span class="value">3</span>
                </div>
                <div class="muscle-slider">
                  <label for="quadrizeps">Quadrizeps</label>
                  <input type="range" id="quadrizeps" min="0" max="5" value="2" oninput="updateValue(this)">
                  <span class="value">2</span>
                </div>
                <div class="muscle-slider">
                  <label for="hamstrings">Hamstrings</label>
                  <input type="range" id="hamstrings" min="0" max="5" value="2" oninput="updateValue(this)">
                  <span class="value">2</span>
                </div>
                <div class="muscle-slider">
                  <label for="calves">Calves</label>
                  <input type="range" id="calves" min="0" max="5" value="1" oninput="updateValue(this)">
                  <span class="value">1</span>
                </div>
                <div class="muscle-slider">
                  <label for="glutes">Glutes</label>
                  <input type="range" id="glutes" min="0" max="5" value="1" oninput="updateValue(this)">
                  <span class="value">1</span>
                </div>
                <div class="muscle-slider">
                  <label for="glutes">Forearm</label>
                  <input type="range" id="forearm" min="0" max="5" value="0" oninput="updateValue(this)">
                  <span class="value">1</span>
                </div>

              </div>
            </div>
          </div>
          <button class="btn-success" id="generate" onclick="new_plan=true;generateTrainingPlan()">Generate training</button>
        </div>
      </div>
      <br id="outputdiv">

    <div class="content">
      <div class="prevent-select" id="exerciseList">
        <h2 id="listTitle">All exercises</h2>
        <p id="hint">Click exercises for favorites or exclusion</p><br>
        <div id="exercises"></div>
      </div>
      <div id="trainingPlanOutput"></div>
      <div class="footer">
        <p>© Copyright Sascha Otto 2025.</p>
      </div>
    </div>
  </div>
  </div>
  <div id="videoModal" class="video-modal hidden">
    <div class="video-content">
      <button id="closeVideo">×</button>
      <iframe id="videoFrame" src="" frameborder="0" allowfullscreen></iframe>
    </div>
  </div>
  <script type="text/javascript" src="exercises.js"></script>
  <script>

let new_plan = false;
let lang = 'en';
const LS_LANG  = 'etp_lang';
const LS_THEME = 'etp_theme'; 

function setLanguageDirect(code) {
  lang = (code === 'de') ? 'de' : 'en';
  localStorage.setItem(LS_LANG, lang);
}

function setThemeDirect(mode) {
  const html = document.documentElement;
  const newTheme = (mode === 'dark') ? 'dark' : 'light';
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem(LS_THEME, newTheme);
}

(function restoreSettingsEarly() {
  const savedLang  = localStorage.getItem(LS_LANG)  || 'en';
  const savedTheme = localStorage.getItem(LS_THEME) || 'dark';

  setLanguageDirect(savedLang);
  setThemeDirect(savedTheme);
})();

let compound = false;

// Globale Variablen
let selectedCategory = "";
let selectedMuscleGroup = "";
//let selectedEquipment = "";
let plan = [];
let selectedEquipment = [];
let availableEquipment = [];
let filteredExercises = [];

function toggleGender() {
      const isChecked = document.getElementById("compoundToggle").checked;
      const label = document.getElementById("genderLabel");
      const menormElements = document.querySelectorAll(".menorm");
      const menorwElements = document.querySelectorAll(".menorw");
      if (isChecked) {
        menormElements.forEach(element => {
          element.classList.add("hidden");
        });
        menorwElements.forEach(element => {
          element.classList.remove("hidden");
        });
        label.innerText = "Female";
      } else {
        menormElements.forEach(element => {
          element.classList.remove("hidden");
        });
        menorwElements.forEach(element => {
          element.classList.add("hidden");
        });
        label.innerText = "Male";
      }
    }

document.querySelectorAll('.advanced-toggle').forEach(toggle => {
  toggle.addEventListener('click', () => {
    const wrapper = toggle.closest('.advanced-wrapper');
    const content = wrapper.querySelector('.advanced-content');
    const button = toggle.querySelector('.setting-btn');

    const isVisible = content.classList.toggle('visible');
    button.classList.toggle('active', isVisible);
  });
});

const paths = document.querySelectorAll('.bodymap path');
    paths.forEach(path => {
  path.addEventListener('click', () => {
    const groupId = path.parentElement.id;
    const groupPaths = document.querySelectorAll(`#${groupId} path`);
    const isActive = Array.from(groupPaths).some(p => p.classList.contains('active'));
    paths.forEach(p => p.classList.remove('active'));
    if (!isActive) {
      groupPaths.forEach(p => p.classList.add('active'));
      selectedMuscleGroup = groupId;
      selectMuscleGroup(groupId);
    }
    else{
      selectCategory(selectedCategory);
    }
  });
});

  let muscleSliderValues = {};


let topbutton = document.getElementById("topbtn");

window.onscroll = function() {scrollFunction()};

function scrollFunction() {
  if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
    topbutton.style.display = "block";
  } else {
    topbutton.style.display = "none";
  }
}

// When the user clicks on the button, scroll to the top of the document
function topFunction() {
  document.body.scrollTop = 0; // For Safari
  document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
}

  function updateValue(slider) {
    const value = parseInt(slider.value, 10);
    const id = slider.id;
    muscleSliderValues[id] = value;

    // Update the visible value
    slider.nextElementSibling.textContent = value;

    // Save to localStorage
    localStorage.setItem("muscleSliderValues", JSON.stringify(muscleSliderValues));
  }

  // Initialize sliders on page load
  document.addEventListener("DOMContentLoaded", () => {
    const savedValues = localStorage.getItem("muscleSliderValues");
    if (savedValues) {
      muscleSliderValues = JSON.parse(savedValues);
      //console.log("Loaded saved slider values:", muscleSliderValues);
    }
    document.querySelectorAll(".muscle-slider input[type='range']").forEach(slider => {
      const id = slider.id;
      const savedValue = muscleSliderValues[id];
      if (typeof savedValue === "number") {
        slider.value = savedValue;
      }
      const value = parseInt(slider.value, 10);
      muscleSliderValues[id] = value;
      slider.nextElementSibling.textContent = value;
    });
    //console.log("Loaded slider values:", muscleSliderValues);
    const savedDays = localStorage.getItem("trainingDays");
  if (savedDays) {
    const days = parseInt(savedDays);
    const daysRange = document.getElementById("daysRange");
    const daysValue = document.getElementById("daysValue");

    if (daysRange && daysValue) {
      daysRange.value = days;
      daysValue.textContent = days + (lang === 'en' ? " days" : " Tage");
    }
  }
  });

function toggleLanguage() {
  const newLang = (lang === 'en') ? 'de' : 'en';
  setLanguageDirect(newLang);

  const langToggleBtn = document.getElementById('toggleLang');
  if (langToggleBtn) langToggleBtn.textContent = (lang === 'en') ? 'DE' : 'EN';

  // re-render UI
  renderExercises();
  if (plan && plan.length > 0) {
    renderTrainingPlan(plan, plan.length);
    renderAvailableEquipment();
  }
  updateUILanguage();
  renderCategories();
  renderMuscleGroups();
  renderEquipment();
}
// --- Exercise Log Storage ---
const LOG_STORE_KEY = 'exerciseLogs_v1';
function safeToggle(showEl, hideEl) {
  if (hideEl && hideEl.style) hideEl.style.display = 'none';
  if (!showEl || !showEl.style) return;
  showEl.style.display = (showEl.style.display === 'none' || !showEl.style.display) ? 'block' : 'none';
}
function getLogKey(ex) { return `exlog-${ex.id}`; }
function _readLogStore() {
  try { return JSON.parse(localStorage.getItem(LOG_STORE_KEY) || '{}'); }
  catch { return {}; }
}
function _writeLogStore(store) {
  localStorage.setItem(LOG_STORE_KEY, JSON.stringify(store));
}
function loadExerciseLog(key) {
  const store = _readLogStore();
  return store[key] || { w1:'', r1:'', w2:'', r2:'', w3:'', r3:'' , w4:'', r4:'' , w5:'', r5:'' };
}
function saveExerciseLog(key, data) {
  const store = _readLogStore();
  store[key] = data;
  _writeLogStore(store);
}
function clearExerciseLog(key) {
  const store = _readLogStore();
  if (store[key]) { delete store[key]; _writeLogStore(store); }
}
function renderLogPanelHTML(panelId, logData) {
  
  const log1 = lang === 'en' ? 'Set'  : 'Satz';
  const log2 = lang === 'en' ? 'Weight'  : 'Gewicht';
  const log3 = lang === 'en' ? 'Repetitions'  : 'Wiederholungen';
  return `
  <div class="tooltip log-panel" id="${panelId}" style="display:none;">
    <div class="log-grid">
      <div></div><div class="log-head">${log2} kg/lb</div><div class="log-head">${log3}</div>
      <div>${log1} 1</div>
      <input class="log-input" type="number" step="0.5" data-log="${panelId}" name="w1" value="${logData.w1}">
      <input class="log-input" type="number" step="1"   data-log="${panelId}" name="r1" value="${logData.r1}">
      <div>${log1} 2</div>
      <input class="log-input" type="number" step="0.5" data-log="${panelId}" name="w2" value="${logData.w2}">
      <input class="log-input" type="number" step="1"   data-log="${panelId}" name="r2" value="${logData.r2}">
      <div>${log1} 3</div>
      <input class="log-input" type="number" step="0.5" data-log="${panelId}" name="w3" value="${logData.w3}">
      <input class="log-input" type="number" step="1"   data-log="${panelId}" name="r3" value="${logData.r3}">
      <div>${log1} 4</div>
      <input class="log-input" type="number" step="0.5" data-log="${panelId}" name="w4" value="${logData.w4}">
      <input class="log-input" type="number" step="1"   data-log="${panelId}" name="r4" value="${logData.r4}">
      <div>${log1} 5</div>
      <input class="log-input" type="number" step="0.5" data-log="${panelId}" name="w5" value="${logData.w5}">
      <input class="log-input" type="number" step="1"   data-log="${panelId}" name="r5" value="${logData.r5}">
    </div>
    <button class="log-clear" data-clear="${panelId}">Clear</button>
  </div>`;
}
function attachLogHandlers(panelId, storageKey, root = document) {
  const panel = root === document
    ? document.getElementById(panelId)
    : root.querySelector(`#${panelId}`);
  if (!panel) return;

  // für Cross-Sync markieren
  panel.classList.add('log-panel');
  panel.dataset.logKey = storageKey;

  const syncFromPanel = () => {
    const inputs = panel.querySelectorAll('input[data-log]');
    const data = {};
    inputs.forEach(inp => { data[inp.name] = inp.value; });
    saveExerciseLog(storageKey, data);
    refreshLogPanels(storageKey, panel); // andere Panels live aktualisieren
  };

  panel.querySelectorAll('input[data-log]').forEach(inp => {
    inp.addEventListener('input',  syncFromPanel);
    inp.addEventListener('change', syncFromPanel);
  });

  const clearBtn = panel.querySelector(`[data-clear="${panelId}"]`);
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      const empty = { w1:'', r1:'', w2:'', r2:'', w3:'', r3:'' };
      saveExerciseLog(storageKey, empty);   // persist leere Werte
      panel.querySelectorAll('input[data-log]').forEach(inp => { inp.value = ''; });
      refreshLogPanels(storageKey, panel);  // andere Panels auch leeren
    });
  }
}
function openVideo(embedUrl) {
  document.getElementById('videoFrame').src = embedUrl;
  document.getElementById('videoModal').classList.remove('hidden');
}

document.getElementById('closeVideo').onclick = () => {
  document.getElementById('videoFrame').src = ''; // stop video
  document.getElementById('videoModal').classList.add('hidden');
};

document.getElementById('videoModal').addEventListener('click', function(event) 
  if (!event.target.closest('.video-content')) {
    document.getElementById('videoFrame').src = ''; // Stop the video
    document.getElementById('videoModal').classList.add('hidden');
  }
});
document.addEventListener('DOMContentLoaded', function() {
  addLanguageToggleButton();
  init();
  const langToggleBtn = document.getElementById('toggleLang');
  if (langToggleBtn) {
    langToggleBtn.textContent = lang === 'en' ? 'DE' : 'EN';
  }
});
function updateUILanguage() {

  const elements = {
    'musclegrp': lang === 'en' ? 'Muscle groups' : 'Muskelgruppe',
    'category': lang === 'en' ? 'Categorys' : 'Kategorie',
    'devicefilter': lang === 'en' ? 'Device filter' : 'Gerätefilter',
    'listTitle': lang === 'en' ? 'All exercises' : 'Alle Übungen',
    'create': lang === 'en' ? 'Create training' : 'Erstelle Training',
    'generate': lang === 'en' ? 'Generate training' : 'Generiere Training',
    'trainingdays': lang === 'en' ? 'Training days in a week:' : 'Trainingstage in der Woche',
    'available': lang === 'en' ? 'Available equipment' : 'Verfügbare Ausrüstung',
    'advanced-label': lang === 'en' ? 'Advanced settings' : 'Erweiterte Funktionen',
    'hint': lang === 'en' ? 'Click exercises for favorites or exclusion' : 'Klicke Übung für Favorit oder Ausschluß',
    'categories h3': lang === 'en' ? 'Categories' : 'Kategorien',
    'muscleGroupContainer h3': lang === 'en' ? 'Specific muscle groups' : 'Spezifische Muskelgruppen',
    'equipment h3': lang === 'en' ? 'Device filter' : 'Gerätefilter'
  };
  if (lang === 'en'){
    if (document.getElementById('toggleBtn').textContent ==='Training') {
      document.getElementById('toggleBtn').textContent = 'Training';
    }
    else if(document.getElementById('toggleBtn').textContent ==='Übungen'){
      document.getElementById('toggleBtn').textContent = 'Exercises';
    }
  }
  else{
    if (document.getElementById('toggleBtn').textContent ==='Training') {
      document.getElementById('toggleBtn').textContent = 'Training';
    }
    else if(document.getElementById('toggleBtn').textContent ==='Exercises'){
      document.getElementById('toggleBtn').textContent = 'Übungen';
    }

  }
  for (const [id, text] of Object.entries(elements)) {
    const element = document.querySelector(`#${id}`);
    if (element) element.textContent = text;
  }
  document.getElementById('daysValue').textContent = parseInt(document.getElementById('daysRange').value) + (lang === 'en' ? " days" : " Tage");
}

function isMobileView() {
    return window.matchMedia('(max-width: 800px)').matches;
}


let steps= 10;
function addLanguageToggleButton() {
  const toggleModeBtn = document.getElementById('toggleMode');
  const langToggleBtn = document.createElement('button');
  langToggleBtn.id = 'toggleLang';
  langToggleBtn.textContent = (lang === 'en') ? 'DE' : 'EN';
  langToggleBtn.onclick = toggleLanguage;
  toggleModeBtn.parentNode.insertBefore(langToggleBtn, toggleModeBtn.nextSibling);
}
window.onload = function() {
renderCategories();
renderEquipment();
updateFilteredExercises();
};
// Kategorien rendern
function clearSavedPlan() {
  localStorage.removeItem('savedTrainingPlan');
  console.log('Saved training plan cleared');
}
function saveFavoritesToLocalStorage() {
  const favoriteMap = {};
  exercises.forEach(ex => {
    if (ex.favorit !== 0) {
      favoriteMap[ex.id] = ex.favorit;
    }
  });
  localStorage.setItem('exerciseFavorites', JSON.stringify(favoriteMap));
}
function restoreFavoritesFromLocalStorage() {
  const stored = localStorage.getItem('exerciseFavorites');
  if (!stored) return;

  const favoriteMap = JSON.parse(stored);
  exercises.forEach(ex => {
    if (favoriteMap.hasOwnProperty(ex.id)) {
      ex.favorit = favoriteMap[ex.id];
    }
  });
}
function refreshLogPanels(storageKey, skipPanel = null) {
  const data = loadExerciseLog(storageKey);
  document.querySelectorAll(`.log-panel[data-log-key="${storageKey}"]`).forEach(p => {
    if (skipPanel && p === skipPanel) return;
    p.querySelectorAll('input[data-log]').forEach(inp => {
      if (Object.prototype.hasOwnProperty.call(data, inp.name)) {
        inp.value = data[inp.name] || '';
      }
    });
  });
}
function savePlan() {
  try {
    localStorage.setItem('savedTrainingPlan', JSON.stringify(plan || []));
  } catch (err) {
    console.error('Error saving to localStorage:', err);
  }
  if (plan && plan.length > 0) {
    console.log('Training plan saved');
    return true;
  }
  return false;
}

function loadPlan() {
    try {
    const savedAvailableLS = localStorage.getItem('savedAvailableEquipment');
    if (savedAvailableLS) {
      availableEquipment = JSON.parse(savedAvailableLS) || [];
      console.log('availableEquipment loaded from localStorage');
    }
  } catch (err) {
    console.error('Error loading availableEquipment:', err);
    availableEquipment = [];
  }
  // load training plan (prefer localStorage; do NOT store big plan in cookie)
  try {
    const savedPlanString = localStorage.getItem('savedTrainingPlan');
    if (savedPlanString) {
      plan = JSON.parse(savedPlanString) || [];
      console.log('Training plan loaded from localStorage');
      return true;
    }
  } catch (error) {
    console.error('Error loading plan from localStorage:', error);
    localStorage.removeItem('savedTrainingPlan');
  }
  return false;
}
function init() {
  const savedLang  = localStorage.getItem(LS_LANG)  || 'en';
  const savedTheme = localStorage.getItem(LS_THEME) || 'light';

  setLanguageDirect(savedLang);
  setThemeDirect(savedTheme);

  // Buttons beschriften
  const toggleBtn = document.getElementById('toggleMode');
  if (toggleBtn) toggleBtn.textContent = (savedTheme === 'dark') ? 'Light mode' : 'Dark mode';

  const langToggleBtn = document.getElementById('toggleLang');
  if (langToggleBtn) langToggleBtn.textContent = (lang === 'en') ? 'DE' : 'EN';

  restoreFavoritesFromLocalStorage();

  // Load plan and equipment
  loadPlan(); // loads availableEquipment and plan (from localStorage or cookie fallback)

  if (plan && plan.length > 0) {
    toggleTrainingPlanForm();
    renderTrainingPlan(plan, plan.length);
  }

  // UI in gewählter Sprache aufziehen
  updateUILanguage();
  renderEquipment();
  renderAvailableEquipment();
}
function renderCategories() {
  const container = document.getElementById('categories');
  container.innerHTML = '';

  Object.keys(muscleGroups).forEach(category => {
    const btn = document.createElement('button');
    btn.textContent = muscleCategoryTrans[lang][category]; // Anzeige
    btn.onclick = () => selectCategory(category);           // Logik
    if (category === selectedCategory) btn.classList.add('active');
    container.appendChild(btn);
  });
}
function renderMuscleGroups() {
  const container = document.getElementById('muscleGroups');
  container.innerHTML = '';
  if (selectedCategory) {
    muscleGroups[selectedCategory].forEach(muscle => {
      const btn = document.createElement('button');
      btn.textContent = muscleGroupTrans[lang][muscle];
      btn.onclick = () => selectMuscleGroup(muscle);
      if (muscle === selectedMuscleGroup) btn.classList.add('active');
      container.appendChild(btn);
    });
  }
}
function renderEquipment() {
  const container = document.getElementById('equipment');
  container.innerHTML = '';

  equipmentTypes.forEach(eq => {
    const btn = document.createElement('button');
    btn.textContent = equipmentTypestrans[lang][eq]; 
    btn.setAttribute('data-eq', eq);
    btn.onclick = () => filterByEquipment(eq);
    if (availableEquipment.includes(eq)) btn.classList.add('active');
    container.appendChild(btn);

  });
}


function renderAvailableEquipment() {
  const container = document.getElementById('availableEquipment');
  container.innerHTML = '';

  equipmentTypes.forEach(eq => {
    const btn = document.createElement('button');
    btn.textContent = equipmentTypestrans[lang][eq];
    btn.classList.add('equipment-btn');
    if (availableEquipment.includes(eq)) btn.classList.add('active');
    btn.onclick = () => toggleEquipment(eq);
    container.appendChild(btn);
  });
}

function renderExercises() {
  const container = document.getElementById('exercises');
  container.innerHTML = '';

    var listfile = "";
  if (filteredExercises.length === 0) {
    container.innerHTML = '<p>' +
      (lang === 'en'
        ? 'Choose a category or muscle group to show exercises.'
        : 'Wähle eine Kategorie oder Muskelgruppe, um Übungen anzuzeigen.') +
      '</p>';
    return;
  }

  filteredExercises.forEach((ex, idx) => {
    const card = document.createElement('div');
    card.className = 'card';

    const muscleGroupText = lang === 'en' ? 'Muscle group' : 'Muskelgruppe';
    const deviceText      = lang === 'en' ? 'Device'       : 'Ausrüstung';
    const effectivityText = lang === 'en' ? 'Effectivity'  : 'Effektivität';

    const videoBtn = ex.url && ex.url.includes("youtube.com/embed/")
      ? `<button class="button-with-icon" onclick="openVideo('${ex.url}')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="icon"><path d="M12 39c-.549 0-1.095-.15-1.578-.447A3.008 3.008 0 0 1 9 36V12c0-1.041.54-2.007 1.422-2.553a3.014 3.014 0 0 1 2.919-.132l24 12a3.003 3.003 0 0 1 0 5.37l-24 12c-.42.21-.885.315-1.341.315z" fill="#ffffff"></path></svg><span class="text">YOUTUBE</span></button>`
      : `<button class="button-with-icon" onclick="window.open('https://www.youtube.com/results?search_query=${encodeURIComponent(ex.name)}+${lang === 'en' ? 'exercise' : 'Übung'}', '_blank');"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="icon"><path d="M12 39c-.549 0-1.095-.15-1.578-.447A3.008 3.008 0 0 1 9 36V12c0-1.041.54-2.007 1.422-2.553a3.014 3.014 0 0 1 2.919-.132l24 12a3.003 3.003 0 0 1 0 5.37l-24 12c-.42.21-.885.315-1.341.315z" fill="#ffffff"></path></svg><span class="text">YOUTUBE SEARCH</span></button>`;

    const tooltipId  = `tooltip-${idx}`;
    const logKey     = getLogKey(ex);
    const logPanelId = `log-list-${ex.id}`;
    const logData    = loadExerciseLog(logKey);
listfile = listfile + ex.name +";muscle group="+ex.muscleGroup+";primary Muscles="+ ex.primeMuscle+";secondary Muscles="+ ex.secondaryMuscle+'\n';
    card.innerHTML = `
      <div class="exercise-title">${ex.name}</div>
      <div style="margin-top:5px;" class="exercise-meta">
        <span><b>${muscleGroupText}:</b> ${muscleGroupTrans[lang][ex.muscleGroup]}</span> |
        <span><b>${deviceText}:</b> ${ex.equipment}</span> |
        <span><b>${effectivityText}:</b> ${'★'.repeat(ex.effectiveness)}</span>
      </div>
      <div class="exercise-desc">${ex.description[lang] || ex.description['en']}</div>
      <div class="button-row">
        <button class="detail-btn" data-tooltip-id="${tooltipId}">Details</button>
        <button class="log-btn" data-log-id="${logPanelId}">Log</button>
        ${videoBtn}
        <button class="fav-btn ${ex.favorit === 1 ? 'favorite' : ''}" title="${ex.favorit === 1 ? 'Favorit entfernen' : 'Als Favorit markieren'}">${ex.favorit === 1 ? '★' : '☆'}</button>
        <button class="disable-btn ${ex.favorit === -1 ? 'unwanted' : ''}" title="${ex.favorit === -1 ? 'Übung wieder erlauben' : 'Übung ausschließen'}">✕</button>
      </div>
      <div class="tooltip" id="${tooltipId}" style="display:none;">
        <strong>${lang === 'en' ? 'Steps' : 'Ablauf'}:</strong><br>${ex.steps?.[lang] || ex.steps?.en || '-'}
      </div>
      ${renderLogPanelHTML(logPanelId, logData)}  <!-- hat Klasse .tooltip für identische Optik -->
    `;

    // UI-Elemente im Card-Root referenzieren
    const detailsBtn = card.querySelector(`.detail-btn[data-tooltip-id="${tooltipId}"]`);
    const tooltip    = card.querySelector(`#${tooltipId}`);
    const logPanel   = card.querySelector(`#${logPanelId}`);
    const logBtn     = card.querySelector(`.log-btn[data-log-id="${logPanelId}"]`);

    // Toggle-Handler: Details <-> Log schließen sich gegenseitig
    if (detailsBtn && tooltip) {
      detailsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        safeToggle(tooltip, logPanel);
      });
    }
     logBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      safeToggle(logPanel, tooltip);
      refreshLogPanels(logKey);
    });

    // Karte in DOM einfügen, danach Handlers für Inputs/Clear binden
    container.appendChild(card);
    attachLogHandlers(logPanelId, logKey, card); 

    // Favorit
    const favBtn = card.querySelector('.fav-btn');
    if (favBtn) {
      favBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        ex.favorit = ex.favorit === 1 ? 0 : 1;
        renderExercises();
        saveFavoritesToLocalStorage();
      });
    }

    // Ausschließen
    const disableBtn = card.querySelector('.disable-btn');
    if (disableBtn) {
      disableBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        ex.favorit = ex.favorit === -1 ? 0 : -1;
        renderExercises();
        saveFavoritesToLocalStorage();
      });
    }
  });
  //console.log(listfile);
}


function selectCategory(category) {
selectedCategory = category;
selectedMuscleGroup = "";
document.getElementById('muscleGroupContainer').style.display = 'block';
renderCategories();
renderMuscleGroups();
updateFilteredExercises();
updateListTitle();
//showExercises();
}
function selectMuscleGroup(muscle) {
selectedMuscleGroup = muscle;
renderMuscleGroups();
updateFilteredExercises();
updateListTitle();
//showExercises();
}
function filterByEquipment(equipment) {
  if (availableEquipment.includes(equipment)) {
    availableEquipment = availableEquipment.filter(eq => eq !== equipment);
  } else {
    availableEquipment.push(equipment);
  }

  // Update main equipment buttons
  const buttons = document.querySelectorAll('#equipment button');
  buttons.forEach(btn => {
    const key = btn.getAttribute('data-eq');
    btn.classList.toggle('active', availableEquipment.includes(key));
  });

  renderAvailableEquipment();
  try {
    localStorage.setItem('savedAvailableEquipment', JSON.stringify(availableEquipment || []));
  } catch (err) {
    console.error('Could not persist availableEquipment after change:', err);
  }

  updateFilteredExercises();
}
function updateFilteredExercises() {
filteredExercises = [...exercises];
if (selectedMuscleGroup) {
filteredExercises = filteredExercises.filter(ex => ex.muscleGroup === selectedMuscleGroup);
}
else if (selectedCategory) {
filteredExercises = filteredExercises.filter(ex => ex.category === selectedCategory);
}
if (availableEquipment.length > 0) {
filteredExercises = filteredExercises.filter(ex => availableEquipment.includes(ex.equipment));
}
filteredExercises.sort((a, b) => b.effectiveness - a.effectiveness);
renderExercises();
}
function updateListTitle() {
const title = document.getElementById('listTitle');
if (selectedMuscleGroup) {
title.textContent = `Exercises for ${selectedMuscleGroup}`;
} else if (selectedCategory) {
title.textContent = `Exercises for ${selectedCategory}`;
} else {
title.textContent = "All exercises";
}
}

function toggleTrainingPlanForm() {
const formContainer = document.getElementById('trainingPlanForm');
const listContainer = document.getElementById('exerciseList');
const toggleBtn = document.getElementById('toggleBtn');
const trainingPlanOutput = document.getElementById('trainingPlanOutput');
const exer = document.getElementById('exer');

if (formContainer.style.display === 'none') {
formContainer.style.display = 'block';
trainingPlanOutput.style.display = 'block';
listContainer.style.display = 'none';
exer.style.display = 'none';
toggleBtn.textContent = lang === 'en' ? 'Exercises' : 'Übungen';
renderAvailableEquipment();
} else {
formContainer.style.display = 'none';
trainingPlanOutput.style.display = 'none';
listContainer.style.display = 'block';
exer.style.display = 'block';
toggleBtn.textContent =  lang === 'en' ? 'Training' : 'Training';
}
}

function showExercises() {
const formContainer = document.getElementById('trainingPlanForm');
const listContainer = document.getElementById('exerciseList');
const toggleBtn = document.getElementById('toggleBtn');
if (formContainer.style.display !== 'none') {
formContainer.style.display = 'none';
listContainer.style.display = 'block';
toggleBtn.textContent =  lang === 'en' ? 'Training' : 'Training';
}
}
function updateDaysValue() {
  const days = parseInt(document.getElementById('daysRange').value);
document.getElementById('daysValue').textContent = days + (lang === 'en' ? " days" : " Tage");

  // Load preset values for selected day count
  const preset = muscleSliderPresets[days];
  if (!preset) return;

  // Update the values and UI
  for (let muscle in preset) {
    const newValue = preset[muscle];
    muscleSliderValues[muscle] = newValue;

    // Update slider in DOM
    const input = document.getElementById(muscle);
    const display = input?.nextElementSibling;

    if (input) input.value = newValue;
    if (display) display.textContent = newValue;
  }
}

function toggleEquipment(equipment) {
if (availableEquipment.includes(equipment)) {
availableEquipment = availableEquipment.filter(eq => eq !== equipment);
} else {
availableEquipment.push(equipment);
}
renderAvailableEquipment();
filterByEquipment('');
}


function toggleFavorite(exerciseName) {
  const exercise = exercises.find(ex => ex.name === exerciseName);

  if (exercise) {
    if (exercise.favorit === 0) {
      exercise.favorit = 1; 
    } else if (exercise.favorit === 1) {
      exercise.favorit = -1;
    } else {
      exercise.favorit = 0;
    }
  }
  updateFilteredExercises();
}

function selectExercisesForGroup(
    availableGroupExercises,
    targetCount,
    targetSubMuscles = [],
    alreadySelectedIds = new Set(),
    prioritizeCompounds = false,
    muscleGroup = null
) {
    // 1. Vorauswahl – nur gültige Kandidaten mit favorit !== -1
    let candidates = availableGroupExercises.filter(ex => ex.favorit !== -1);
    const initialCandidateCount = candidates.length;

    // 2. Falls zu wenig Kandidaten, Fallback mit allgemeinem Pool
    if (initialCandidateCount < targetCount) {
        const fallbackEquipments = ["None"]; // erweiterbar
        const needed = targetCount - initialCandidateCount;

        const fallback = exercises
            .filter(ex =>
                fallbackEquipments.includes(ex.equipment) &&
                ex.favorit !== -1 &&
                (!muscleGroup || ex.muscleGroup === muscleGroup) &&
                !candidates.some(c => c.id === ex.id)
            )
            .slice(0, needed);

        if (fallback.length > 0) {
            console.warn(`INFO: Nur ${initialCandidateCount} spezifische Übungen für ${muscleGroup || 'Gruppe'} gefunden. Ergänze mit ${fallback.length} Fallback-Übungen.`);
            candidates = candidates.concat(fallback);
        } else if (initialCandidateCount === 0) {
            console.warn("WARNUNG: Keine passenden Kandidaten im ersten Schritt gefunden. Fahre mit Recovery fort.");
            // KEIN return – Recovery später
        }
    }

    // Initialisierungen
    const selected = [];
    const selectedIdsInThisCall = new Set();
    const primeMusclesCovered = new Set();
    const subMusclesCovered = new Set();

    // Überschneidungs-Check
    const checkOverlap = (exercise) => {
        const primeMuscles = exercise.primeMuscle || [];
        if (primeMuscles.length === 0) return false;

        const newMuscles = primeMuscles.filter(m => !primeMusclesCovered.has(m));
        const overlapRatio = (primeMuscles.length - newMuscles.length) / primeMuscles.length;
        return overlapRatio > 0.7 && newMuscles.length <= 1;
    };

    // PHASE 1: Favoriten zuerst
    const favorites = candidates
        .filter(ex => ex.favorit === 1)
        .sort((a, b) => b.effectiveness - a.effectiveness);

    for (const fav of favorites) {
        if (selected.length >= targetCount) break;
        if (alreadySelectedIds.has(fav.id)) continue;

        const isFatiguing = (fav.primeMuscle || []).every(m => primeMusclesCovered.has(m));
        if (!isFatiguing) {
            selected.push(fav);
            selectedIdsInThisCall.add(fav.id);
            (fav.primeMuscle || []).forEach(m => primeMusclesCovered.add(m));
            (fav.primeMuscle || []).filter(m => targetSubMuscles.includes(m)).forEach(sm => subMusclesCovered.add(sm));
        }
    }
    const sortedCandidates = candidates
    .filter(ex => !selectedIdsInThisCall.has(ex.id))
    .sort((a, b) => {
        return b.effectiveness - a.effectiveness;
    });
    for (const exercise of sortedCandidates) {
        if (selected.length >= targetCount) break;
        if (alreadySelectedIds.has(exercise.id)) continue;
        if (!checkOverlap(exercise)) {
            selected.push(exercise);
            selectedIdsInThisCall.add(exercise.id);
            (exercise.primeMuscle || []).forEach(m => primeMusclesCovered.add(m));
            (exercise.primeMuscle || []).filter(m => targetSubMuscles.includes(m)).forEach(sm => subMusclesCovered.add(sm));
        }
    }

    // PHASE 3: Letzter Versuch – fülle restliche Slots
    const remainingSlots = targetCount - selected.length;
    if (remainingSlots > 0) {
        console.warn(`WARNUNG: ${muscleGroup || 'Unbekannt'} Overlap-Check hat verhindert, dass das Ziel erreicht wird. Fülle die restlichen ${remainingSlots} Plätze auf.`);

        const finalFallbackCandidates = candidates.filter(ex =>
            !selectedIdsInThisCall.has(ex.id) &&
            !alreadySelectedIds.has(ex.id)
        );

        finalFallbackCandidates.sort((a, b) => {
            if (b.effectiveness !== a.effectiveness) return b.effectiveness - a.effectiveness;
            return 0;
        });

        for (const exercise of finalFallbackCandidates) {
            if (selected.length >= targetCount) break;
            selected.push(exercise);
            selectedIdsInThisCall.add(exercise.id);
        }
    }
    // PHASE 4: Rückfallstrategie – Wiederholung erlauben bei Muskelgruppen-Blockade
    if (selected.length < targetCount) {
    const remainingNeeded = targetCount - selected.length;

    // Allow exercises from same muscleGroup that were already used (only if needed)
    const reusable = exercises.filter(ex =>
        alreadySelectedIds.has(ex.id) &&
        ex.muscleGroup === muscleGroup &&
        !selectedIdsInThisCall.has(ex.id) // avoid duplicates in current selection
    ).slice(0, remainingNeeded);

    if (reusable.length > 0) {
        console.warn(`⚠️ Fallback: Erlaube ${reusable.length} Wiederholungen aus Muskelgruppe "${muscleGroup}" zum Auffüllen (${selected.length}/${targetCount}).`);
        for (const ex of reusable) {
            selected.push(ex);
            selectedIdsInThisCall.add(ex.id); 
        }
    }
}

    //// Sortierung final: Compound vs Isolation (wenn aktiviert)
    //selected.sort((a, b) => {
    //    const isCompoundA = (a.secondaryMuscle && a.secondaryMuscle.length > 1);
    //    const isCompoundB = (b.secondaryMuscle && b.secondaryMuscle.length > 1);
    //    if (compound) {
    //        if (isCompoundA && !isCompoundB) return -1;
    //        if (!isCompoundA && isCompoundB) return 1;
    //    }
    //    return b.effectiveness - a.effectiveness;
    //});
    // Sortierung final: Nach neuer Muskelabdeckung + Sekundärmuskeln (wenn aktiviert)
    selected.sort((a, b) => {
        if (prioritizeCompounds) {
            const countMuscles = (ex) => {
                const primeNew = (ex.primeMuscle || []).filter(m => !primeMusclesCovered.has(m)).length;
                const secondary = (ex.secondaryMuscle || []).length;
                return primeNew + secondary;
            };

            const aScore = countMuscles(a);
            const bScore = countMuscles(b);

            if (bScore !== aScore) return bScore - aScore;
        }

        // Bei Gleichstand oder wenn Compound nicht priorisiert → Effektivität
        return b.effectiveness - a.effectiveness;
    });

    selected.forEach(ex => alreadySelectedIds.add(ex.id));

    return selected.slice(0, targetCount);
}


function generateTrainingPlan() {
  localStorage.setItem("muscleSliderValues", JSON.stringify(muscleSliderValues));
const days = parseInt(document.getElementById('daysRange').value);
localStorage.setItem("trainingDays", days.toString());


const availableExercises = exercises.filter(ex =>
availableEquipment.includes(ex.equipment)
);
const pushBrust = availableExercises.filter(ex => ex.muscleGroup === "Chest");
const pushSchultern = availableExercises.filter(ex => ex.muscleGroup === "Shoulders");
const pushTriceps = availableExercises.filter(ex => ex.muscleGroup === "Triceps");
const pullRücken = availableExercises.filter(ex => ex.muscleGroup === "Back");
const pullBiceps = availableExercises.filter(ex => ex.muscleGroup === "Biceps");
const legQuadrizeps = availableExercises.filter(ex => ex.muscleGroup === "Quadrizeps");
const legHamstrings = availableExercises.filter(ex => ex.muscleGroup === "Hamstrings");
const legGesäß = availableExercises.filter(ex => ex.muscleGroup === "Glutes");
const legWaden = availableExercises.filter(ex => ex.muscleGroup === "Calves");
const coreBauch = availableExercises.filter(ex => ex.muscleGroup === "Abs");
const pullForearm = availableExercises.filter(ex => ex.muscleGroup === "Forearm");
//const coreUntererRücken = availableExercises.filter(ex => ex.muscleGroup === "Unterer Rücken");

const targetChestSubMuscles = ["Pectoralis (Mid)","Pectoralis (Upper)", "Pectoralis (Lower)","Pectoralis (Outer/Stretch)"];

const targetBackSubMuscles = ["Latissimus dorsi", "Erector Spinae", "Trapezius (Mid)", "Trapezius (Lower)","Rhomboids" ];

const targetShoulderSubMuscles = ["Deltoid (Anterior)", "Deltoid (Lateral)", "Deltoid (Posterior)", "Trapezius (Upper)","Rotator Cuff"];

const targetQuadSubMuscles = ["Rectus Femoris", "Vastus Lateralis", "Vastus Medialis", "Vastus Intermedius"];

const targetHamstringSubMuscles = ["Hamstrings (Knee Flexion)","Hamstrings (Hip Extension)" ];

const targetGluteSubMuscles = ["Gluteus Maximus", "Gluteus Medius", "Gluteus Minimus"];

const targetTricepsSubMuscles = ["Triceps (Long Head)", "Triceps (Lateral Head)", "Triceps (Medial Head)"];

const targetBicepsSubMuscles = ["Biceps Brachii (Long Head)", "Biceps Brachii (Short Head)", "Brachialis", "Brachioradialis"];

const targetCalfSubMuscles = ["Gastrocnemius", "Soleus"];
const targetAbsSubMuscles = ["Rectus Abdominis", "External Obliques", "Internal Obliques","Transverse Abdominis"];
const targetForearmSubMuscles = ["Wrist Flexors", "Wrist Extensors", "Finger Flexors"];
plan = [];
let weeklySelectedIds = new Set();

const ChestCount = muscleSliderValues["chest"];
const BackCount =  muscleSliderValues["back"];
const ShoulderCount =  muscleSliderValues["shoulders"];
const BicepsCount =   muscleSliderValues["biceps"];
const TricepsCount =   muscleSliderValues["triceps"];
const QuadCount =  muscleSliderValues["quadrizeps"];
const HamstringCount =  muscleSliderValues["hamstrings"];
const GluteCount =  muscleSliderValues["glutes"];
const CalfCount =  muscleSliderValues["calves"];
const AbsCount =  muscleSliderValues["abs"];
const ForearmCount =  muscleSliderValues["forearm"];


if (days === 1) {
console.log("Generating 1-Day Full Body Plan (Prioritizing Compounds)");

const exercisesDay1 = [
...selectExercisesForGroup(legQuadrizeps, QuadCount, targetQuadSubMuscles, weeklySelectedIds, compound,"Quadrizeps"),
...selectExercisesForGroup(pushBrust, ChestCount, targetChestSubMuscles, weeklySelectedIds, compound,"Chest"),
...selectExercisesForGroup(pullRücken, BackCount, targetBackSubMuscles, weeklySelectedIds, compound,"Back"),
...selectExercisesForGroup(pushSchultern, ShoulderCount, targetShoulderSubMuscles, weeklySelectedIds, compound,"Shoulders"),
...selectExercisesForGroup(pullBiceps, BicepsCount, targetBicepsSubMuscles, weeklySelectedIds, compound,"Biceps"),
...selectExercisesForGroup(legHamstrings, HamstringCount, targetHamstringSubMuscles, weeklySelectedIds, compound,"Hamstrings"),
...selectExercisesForGroup(legGesäß, GluteCount, targetGluteSubMuscles, weeklySelectedIds, compound,"Glutes"),
...selectExercisesForGroup(pushTriceps, TricepsCount, targetTricepsSubMuscles, weeklySelectedIds,compound,"Triceps"),
...selectExercisesForGroup(coreBauch, AbsCount, targetAbsSubMuscles, weeklySelectedIds, compound,"Abs"),
...selectExercisesForGroup(pullForearm, ForearmCount, targetForearmSubMuscles, weeklySelectedIds,compound,"Forearm"),
...selectExercisesForGroup(legWaden, CalfCount, targetCalfSubMuscles, weeklySelectedIds,compound,"Calves")
];
plan = [{ day: 1, name: "Full Body (Compound Focus)", exercises: exercisesDay1 }];

} else if (days === 2) {
// Upper / Lower Split
console.log("Generating 2-Day Upper/Lower Plan");
const upperDay = [
...selectExercisesForGroup(pushBrust, ChestCount, targetChestSubMuscles, weeklySelectedIds,false,"Chest"),
...selectExercisesForGroup(pullRücken, BackCount, targetBackSubMuscles, weeklySelectedIds,false,"Back"),
...selectExercisesForGroup(pushSchultern, ShoulderCount, targetShoulderSubMuscles, weeklySelectedIds,false,"Shoulders"),
...selectExercisesForGroup(pullBiceps, BicepsCount, targetBicepsSubMuscles, weeklySelectedIds,false,"Biceps"),
...selectExercisesForGroup(pushTriceps, TricepsCount, targetTricepsSubMuscles, weeklySelectedIds,false,"Triceps"),
...selectExercisesForGroup(pullForearm, ForearmCount, targetForearmSubMuscles, weeklySelectedIds,false,"Forearm"),
];
const lowerDay = [
...selectExercisesForGroup(legQuadrizeps, QuadCount, targetQuadSubMuscles, weeklySelectedIds,false,"Quadrizeps"),
...selectExercisesForGroup(legHamstrings, HamstringCount, targetHamstringSubMuscles, weeklySelectedIds,false,"Hamstrings"),
...selectExercisesForGroup(legGesäß, GluteCount, targetGluteSubMuscles, weeklySelectedIds,false,"Glutes"),
...selectExercisesForGroup(legWaden, CalfCount, targetCalfSubMuscles, weeklySelectedIds,false,"Calves"),
...selectExercisesForGroup(coreBauch, AbsCount, targetAbsSubMuscles, weeklySelectedIds,false,"Abs"),
];
plan = [
{ day: 1, name: "Upper body", exercises: upperDay },
{ day: 2, name: "Lower body & Core", exercises: lowerDay }
];

} else if (days === 3) {
console.log("Generating 3-Day PPL Plan");
const pushDay = [
  ...selectExercisesForGroup(pushBrust, ChestCount, targetChestSubMuscles, weeklySelectedIds,false,"Chest"),
  ...selectExercisesForGroup(pushSchultern, ShoulderCount, targetShoulderSubMuscles, weeklySelectedIds,false,"Shoulders"),
  ...selectExercisesForGroup(pushTriceps, TricepsCount, targetTricepsSubMuscles, weeklySelectedIds,false,"Triceps"),
];
const pullDay = [
...selectExercisesForGroup(pullRücken,BackCount, targetBackSubMuscles, weeklySelectedIds,false,"Back"),
...selectExercisesForGroup(pullBiceps, BicepsCount, targetBicepsSubMuscles, weeklySelectedIds,false,"Biceps"),
...selectExercisesForGroup(pullForearm, ForearmCount, targetForearmSubMuscles, weeklySelectedIds,false,"Forearm"),
];
const legDay = [
...selectExercisesForGroup(legQuadrizeps, QuadCount, targetQuadSubMuscles, weeklySelectedIds,false,"Quadrizeps"),
...selectExercisesForGroup(legHamstrings, HamstringCount, targetHamstringSubMuscles, weeklySelectedIds,false,"Hamstrings"),
...selectExercisesForGroup(legGesäß, GluteCount, targetGluteSubMuscles, weeklySelectedIds,false,"Glutes"),
...selectExercisesForGroup(legWaden, CalfCount, targetCalfSubMuscles, weeklySelectedIds,false,"Calves"),
...selectExercisesForGroup(coreBauch, AbsCount, targetAbsSubMuscles, weeklySelectedIds,false,"Abs"),
];
plan = [
{ day: 1, name: "Push", exercises: pushDay },
{ day: 2, name: "Pull", exercises: pullDay },
{ day: 3, name: "Legs & Core", exercises: legDay }
];
}
else if (days === 4) {
// Upper / Lower Split x2
console.log("Generating 4-Day Upper/Lower Plan");
//const upperChestCount = 2;
//const upperBackCount = 2;
//const upperShoulderCount = 1;
//const upperBicepsCount = 1;
//const upperTricepsCount = 1;
//
//const lowerQuadCount = 1;
//const lowerHamstringCount = 1;
//const lowerGluteCount = 1;
//const lowerCalfCount = 1;
//const lowerCoreCount = 1;
const upperDay1 = [
...selectExercisesForGroup(pushBrust, ChestCount, targetChestSubMuscles, weeklySelectedIds,false,"Chest"),
...selectExercisesForGroup(pullRücken, BackCount, targetBackSubMuscles, weeklySelectedIds,false,"Back"),
...selectExercisesForGroup(pushSchultern, ShoulderCount, targetShoulderSubMuscles, weeklySelectedIds,false,"Shoulders"),
...selectExercisesForGroup(pullBiceps, BicepsCount, targetBicepsSubMuscles, weeklySelectedIds,false,"Biceps"),
...selectExercisesForGroup(pushTriceps, TricepsCount, targetTricepsSubMuscles, weeklySelectedIds,false,"Triceps"),
...selectExercisesForGroup(pullForearm, ForearmCount, targetForearmSubMuscles, weeklySelectedIds,false,"Forearm"),
];
const lowerDay1 = [
...selectExercisesForGroup(legQuadrizeps, QuadCount, targetQuadSubMuscles, weeklySelectedIds,false,"Quadrizeps"),
...selectExercisesForGroup(legHamstrings, HamstringCount, targetHamstringSubMuscles, weeklySelectedIds,false,"Hamstrings"),
...selectExercisesForGroup(legGesäß,  GluteCount, targetGluteSubMuscles, weeklySelectedIds,false,"Glutes"),
...selectExercisesForGroup(legWaden,  CalfCount, targetCalfSubMuscles, weeklySelectedIds,false,"Calves"),
...selectExercisesForGroup(coreBauch, AbsCount, targetAbsSubMuscles, weeklySelectedIds,false,"Abs"),
];
const upperDay2 = [
...selectExercisesForGroup(pushBrust,  ChestCount, targetChestSubMuscles, weeklySelectedIds,false,"Chest"),
...selectExercisesForGroup(pullRücken, BackCount, targetBackSubMuscles, weeklySelectedIds,false,"Back"),
...selectExercisesForGroup(pushSchultern, ShoulderCount, targetShoulderSubMuscles, weeklySelectedIds,false,"Shoulders"),
...selectExercisesForGroup(pullBiceps, BicepsCount, targetBicepsSubMuscles, weeklySelectedIds,false,"Biceps"),
...selectExercisesForGroup(pushTriceps, TricepsCount, targetTricepsSubMuscles, weeklySelectedIds,false,"Triceps"),
...selectExercisesForGroup(pullForearm, ForearmCount, targetForearmSubMuscles, weeklySelectedIds,false,"Forearm"),
];
const lowerDay2 = [
...selectExercisesForGroup(legQuadrizeps, QuadCount, targetQuadSubMuscles, weeklySelectedIds,false,"Quadrizeps"),
...selectExercisesForGroup(legHamstrings, HamstringCount, targetHamstringSubMuscles, weeklySelectedIds,false,"Hamstrings"),
...selectExercisesForGroup(legGesäß, GluteCount, targetGluteSubMuscles, weeklySelectedIds,false,"Glutes"),
...selectExercisesForGroup(legWaden, CalfCount, targetCalfSubMuscles, weeklySelectedIds,false,"Calves"),
...selectExercisesForGroup(coreBauch, AbsCount, targetAbsSubMuscles, weeklySelectedIds,false,"Abs"),
];

plan = [
{ day: 1, name: "Upper body (Strength)", exercises: upperDay1 },
{ day: 2, name: "Lower body & Core (Strength)", exercises: lowerDay1 },
{ day: 3, name: "Upper body", exercises: upperDay2 }, 
{ day: 4, name: "Lower body & Core", exercises: lowerDay2 }
];

} else if (days === 5) {
console.log("Generating 5-Day PPL + Upper/Lower Plan");
const pushChestCount = ChestCount;
const pushShoulderCount = ShoulderCount;
const pushTricepsCount = TricepsCount;

const pullBackCount = BackCount;
const pullBicepsCount = BicepsCount;

const legQuadCount = QuadCount;
const legHamstringCount = HamstringCount;
const legGluteCount = GluteCount;
const legCalfCount = CalfCount;
const legCoreCount = AbsCount;

const upperChestCount = 2;
const upperBackCount = 2;
const upperShoulderCount = 1;
const upperBicepsCount = 1;
const upperTricepsCount = 1;

const lowerQuadCount = 2;
const lowerHamstringCount = 1;
const lowerGluteCount = 1;
const lowerCalfCount = 1;
const lowerCoreCount = 1;


const pushDay = selectExercisesForGroup(pushBrust, pushChestCount, targetChestSubMuscles, weeklySelectedIds,false,"Chest")
              .concat(selectExercisesForGroup(pushSchultern, pushShoulderCount, targetShoulderSubMuscles, weeklySelectedIds,false,"Shoulders"))
              .concat(selectExercisesForGroup(pushTriceps, pushTricepsCount, targetTricepsSubMuscles, weeklySelectedIds,false,"Triceps"));

const pullDay = selectExercisesForGroup(pullRücken, pullBackCount, targetBackSubMuscles, weeklySelectedIds,false,"Back")
              .concat(selectExercisesForGroup(pullBiceps, pullBicepsCount, targetBicepsSubMuscles, weeklySelectedIds,false,"Biceps"))
              .concat(selectExercisesForGroup(pullForearm, ForearmCount, targetForearmSubMuscles, weeklySelectedIds,false,"Forearm"));

const legDay = selectExercisesForGroup(legQuadrizeps, legQuadCount, targetQuadSubMuscles, weeklySelectedIds,false,"Quadrizeps")
            .concat(selectExercisesForGroup(legHamstrings, legHamstringCount, targetHamstringSubMuscles, weeklySelectedIds,false,"Hamstrings"))
            .concat(selectExercisesForGroup(legGesäß, legGluteCount, targetGluteSubMuscles, weeklySelectedIds,false,"Glute"))
            .concat(selectExercisesForGroup(legWaden, legCalfCount, targetCalfSubMuscles, weeklySelectedIds,false,"Calves"))
            .concat(selectExercisesForGroup(coreBauch, legCoreCount, targetAbsSubMuscles, weeklySelectedIds,false,"Abs"));

const upperDay = selectExercisesForGroup(pushBrust, upperChestCount, targetChestSubMuscles, weeklySelectedIds,false,"Chest")
              .concat(selectExercisesForGroup(pullRücken, upperBackCount, targetBackSubMuscles, weeklySelectedIds,false,"Back"))
              .concat(selectExercisesForGroup(pushSchultern, upperShoulderCount, targetShoulderSubMuscles, weeklySelectedIds,false,"Shoulders"))
              .concat(selectExercisesForGroup(pullBiceps, upperBicepsCount, targetBicepsSubMuscles, weeklySelectedIds,false,"Biceps"))
              .concat(selectExercisesForGroup(pushTriceps, upperTricepsCount, targetTricepsSubMuscles, weeklySelectedIds,false,"Triceps"))

const lowerDay = selectExercisesForGroup(legQuadrizeps, lowerQuadCount, targetQuadSubMuscles, weeklySelectedIds,false,"Chest")
              .concat(selectExercisesForGroup(legHamstrings, lowerHamstringCount, targetHamstringSubMuscles, weeklySelectedIds,false,"Hamstrings"))
              .concat(selectExercisesForGroup(legGesäß, lowerGluteCount, targetGluteSubMuscles, weeklySelectedIds,false,"Glutes"))
              .concat(selectExercisesForGroup(legWaden, lowerCalfCount, targetCalfSubMuscles, weeklySelectedIds,false,"Calves"))
              .concat(selectExercisesForGroup(coreBauch, lowerCoreCount, targetAbsSubMuscles, weeklySelectedIds,false,"Abs"));

// Example structure PPLRU (Push, Pull, Legs, Rest, Upper, Lower, Rest)
plan = [
{ day: 1, name: "Upper body (Strength)", exercises: upperDay },
{ day: 2, name: "Lower body & Core (Strength)", exercises: lowerDay },
{ day: 3, name: "Push", exercises: pushDay },
{ day: 4, name: "Pull", exercises: pullDay },
{ day: 5, name: "Legs & Core", exercises: legDay }
];

} else if (days === 6) {
// PPL x2 Split
console.log("Generating 6-Day PPL x2 Plan");
// Define counts per session
const pushChestCount = ChestCount;
const pushShoulderCount = ShoulderCount;
const pushTricepsCount = TricepsCount;

const pullBackCount = BackCount;
const pullBicepsCount = BicepsCount;

const legQuadCount = QuadCount;
const legHamstringCount = HamstringCount;
const legGluteCount = GluteCount;
const legCalfCount = CalfCount;
const legCoreCount = AbsCount;

// Generate PPL Cycle 1
const pushDay1 = selectExercisesForGroup(pushBrust, pushChestCount, targetChestSubMuscles, weeklySelectedIds,false,"Chest")
              .concat(selectExercisesForGroup(pushSchultern, pushShoulderCount, targetShoulderSubMuscles, weeklySelectedIds,false,"Shoulders"))
              .concat(selectExercisesForGroup(pushTriceps, pushTricepsCount, targetTricepsSubMuscles, weeklySelectedIds,false,"Triceps"));
const pullDay1 = selectExercisesForGroup(pullRücken, pullBackCount, targetBackSubMuscles, weeklySelectedIds,false,"Back")
              .concat(selectExercisesForGroup(pullBiceps, pullBicepsCount, targetBicepsSubMuscles, weeklySelectedIds,false,"Biceps"))
              .concat(selectExercisesForGroup(pullForearm, ForearmCount, targetForearmSubMuscles, weeklySelectedIds,false,"Forearm"));
const legDay1 = selectExercisesForGroup(legQuadrizeps, legQuadCount, targetQuadSubMuscles, weeklySelectedIds,false,"Quadrizeps")
            .concat(selectExercisesForGroup(legHamstrings, legHamstringCount, targetHamstringSubMuscles, weeklySelectedIds,false,"Hamstrings"))
            .concat(selectExercisesForGroup(legGesäß, legGluteCount, targetGluteSubMuscles, weeklySelectedIds,false,"Glutes"))
            .concat(selectExercisesForGroup(legWaden, legCalfCount, targetCalfSubMuscles, weeklySelectedIds,false,"Calves"))
            .concat(selectExercisesForGroup(coreBauch, legCoreCount, targetAbsSubMuscles, weeklySelectedIds,false,"Abs"));

// Generate PPL Cycle 2 - will likely select different exercises
const pushDay2 = selectExercisesForGroup(pushBrust, pushChestCount, targetChestSubMuscles, weeklySelectedIds,false,"Chest")
              .concat(selectExercisesForGroup(pushSchultern, pushShoulderCount, targetShoulderSubMuscles, weeklySelectedIds,false,"Shoulders"))
              .concat(selectExercisesForGroup(pushTriceps, pushTricepsCount, targetTricepsSubMuscles, weeklySelectedIds,false,"Triceps"));
const pullDay2 = selectExercisesForGroup(pullRücken, pullBackCount, targetBackSubMuscles, weeklySelectedIds,false,"Back")
              .concat(selectExercisesForGroup(pullBiceps, pullBicepsCount, targetBicepsSubMuscles, weeklySelectedIds,false,"Biceps"))
              .concat(selectExercisesForGroup(pullForearm, ForearmCount, targetForearmSubMuscles, weeklySelectedIds,false,"Forearm"));
const legDay2 = selectExercisesForGroup(legQuadrizeps, legQuadCount, targetQuadSubMuscles, weeklySelectedIds,false,"Quadrizeps")
            .concat(selectExercisesForGroup(legHamstrings, legHamstringCount, targetHamstringSubMuscles, weeklySelectedIds,false,"Hamstrings"))
            .concat(selectExercisesForGroup(legGesäß, legGluteCount, targetGluteSubMuscles, weeklySelectedIds,false,"Glutes"))
            .concat(selectExercisesForGroup(legWaden, legCalfCount, targetCalfSubMuscles, weeklySelectedIds,false,"Calves"))
            .concat(selectExercisesForGroup(coreBauch, legCoreCount, targetAbsSubMuscles, weeklySelectedIds,false,"Abs"));

plan = [
{ day: 1, name: "Push (Strength)", exercises: pushDay1 },
{ day: 2, name: "Pull (Strength)", exercises: pullDay1 },
{ day: 3, name: "Legs & Core (Strength)", exercises: legDay1 },
{ day: 4, name: "Push", exercises: pushDay2 },
{ day: 5, name: "Pull", exercises: pullDay2 },
{ day: 6, name: "Legs & Core", exercises: legDay2 } 
];
}
else {
plan = [{ day: 1, name: "No plan for this days count", exercises: [] }];
}
savePlan();
renderTrainingPlan(plan, days);
}



function renderTrainingPlan(plan, days) {
  const container = document.getElementById('trainingPlanOutput');
  if (plan.length === 0 || plan[0].exercises.length === 0) {
    container.innerHTML = '<div class="card gradient-border" style="margin-top:20px;"><p>' + 
      (lang === 'en' ? 'Please choose at least one training method, to create a training plan.' : 
                       'Bitte wähle mindestens eine Trainingsmethode, um einen Trainingsplan zu erstellen.') + '</p></div>';
    return;
  }
  const yourPersonalPlanText = lang === 'en' ? 'Your personal' : 'Dein persönlicher';
  const dayText = lang === 'en' ? 'day' : 'Tage';
  const planText = lang === 'en' ? 'plan' : 'Plan';
  const dayTranslation = lang === 'en' ? 'Day' : 'Tag';
  const deviceText = lang === 'en' ? 'Device' : 'Ausrüstung';
  const effectivityText = lang === 'en' ? 'Effectivity' : 'Effektivität';
  const recommendationText = lang === 'en' ? 'Recommendation' : 'Empfehlung';
  const setsRepsText = lang === 'en' ? '3-4 sets, 8-12 repetitions for optimal muscle growth' : 
                                       '3-4 Sätze, 8-12 Wiederholungen für optimales Muskelwachstum';
  const switchExerciseText = lang === 'en' ? '🔀' : '🔀';
  const trainingTipsText = lang === 'en' ? 'Training tips' : 'Trainingstipps';
  const muscleGroupText = lang === 'en' ? 'Muscle group' : 'Muskelgruppe';

  let html = `
  <div style="margin-top:5px;">
    <h2>${yourPersonalPlanText} ${days}-${dayText} ${planText}:</h2>
    <div style="margin-top:15px;">
  `;
  plan.forEach(day => {
    let dayName = day.name;
    if (lang === 'de') {
      // Translation mapping for day names
      const nameTranslations = {
        "Full Body": "Ganzkörper",
        "Upper body (Strength)": "Oberkörper (Stärke)",
        "Lower body & Core (Strength)": "Unterkörper & Rumpf (Stärke)",
        "Push (Strength)": "Drücken (Stärke)",
        "Pull (Strength)": "Ziehen (Stärke)",
        "Legs & Core (Strength)": "Beine & Rumpf (Stärke)",
        "Upper body": "Oberkörper",
        "Lower body & Core": "Unterkörper & Rumpf",
        "Push": "Drücken",
        "Pull": "Ziehen",
        "Legs & Core": "Beine & Rumpf",
      };

      for (const [en, de] of Object.entries(nameTranslations)) {
        if (dayName.includes(en)) {
          dayName = dayName.replace(en, de);
          break;
        }
      }
    }

    html += `
    <div class="card gradient-border">
      <h4>${dayTranslation} ${day.day}: ${dayName}</h4>
      <div style="margin-top:10px;">
    `;
    day.exercises.forEach((ex, index) => {
    const tooltipId = `tooltip-${day.day}-${index}`;
      
    const videoBtn = ex.url && ex.url.includes("youtube.com/embed/")
      ? `<button class="button-with-icon" onclick="openVideo('${ex.url}')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="icon"><path d="M12 39c-.549 0-1.095-.15-1.578-.447A3.008 3.008 0 0 1 9 36V12c0-1.041.54-2.007 1.422-2.553a3.014 3.014 0 0 1 2.919-.132l24 12a3.003 3.003 0 0 1 0 5.37l-24 12c-.42.21-.885.315-1.341.315z" fill="#ffffff"></path></svg><span class="text">YOUTUBE</span></button>`
      : `<button class="button-with-icon" onclick="window.open('https://www.youtube.com/results?search_query=${encodeURIComponent(ex.name)}+${lang === 'en' ? 'exercise' : 'Übung'}', '_blank');"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="icon"><path d="M12 39c-.549 0-1.095-.15-1.578-.447A3.008 3.008 0 0 1 9 36V12c0-1.041.54-2.007 1.422-2.553a3.014 3.014 0 0 1 2.919-.132l24 12a3.003 3.003 0 0 1 0 5.37l-24 12c-.42.21-.885.315-1.341.315z" fill="#ffffff"></path></svg><span class="text">YOUTUBE SEARCH</span></button>`;


const logKey = getLogKey(ex);
const logPanelId = `log-plan-${day.day}-${ex.id}`;
const logData = loadExerciseLog(logKey);
html += `
  <div class="exercise-card" id="exercise-${day.day}-${index}">
    <div class="exercise-header">
      <div class="exercise-title">${ex.name}</div>
    </div>
    <div class="exercise-meta">
      <span><b>${muscleGroupText}:</b> ${muscleGroupTrans[lang][ex.muscleGroup]}</span> | 
      <span><b>${deviceText}:</b> ${ equipmentTypestrans[lang][ex.equipment]}</span> |
      <span><b>${effectivityText}:</b> ${'★'.repeat(ex.effectiveness)}</span>
    </div>
    <div class="exercise-desc">${ex.description[lang] || ex.description['en']}</div>
    <div class="button-row">
      <button class="detail-btn" data-tooltip-id="${tooltipId}">Details</button>
      <button class="log-btn" data-log-id="${logPanelId}">Log</button>

      ${videoBtn}
      <button class="shuffle" onclick="shuffleExercise(${day.day}, ${index}, '${ex.muscleGroup}', '${ex.equipment}')">
        <svg class="svg" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M2 7h-2v-2h2c3.49 0 5.48 1.221 6.822 2.854-.41.654-.754 1.312-1.055 1.939-1.087-1.643-2.633-2.793-5.767-2.793zm16 10c-3.084 0-4.604-1.147-5.679-2.786-.302.627-.647 1.284-1.06 1.937 1.327 1.629 3.291 2.849 6.739 2.849v3l6-4-6-4v3zm0-10v3l6-4-6-4v3c-5.834 0-7.436 3.482-8.85 6.556-1.343 2.921-2.504 5.444-7.15 5.444h-2v2h2c5.928 0 7.543-3.511 8.968-6.609 1.331-2.893 2.479-5.391 7.032-5.391z"/></svg>
      </button>
    </div>
    <div class="tooltip" id="${tooltipId}" style="display: none;">
      <strong>${lang === 'en' ? 'Steps' : 'Ablauf'}:</strong><br>${ex.steps?.[lang] || ex.steps?.en || '-'}
    </div>

    ${renderLogPanelHTML(logPanelId, logData)}
  </div>
`;
  });

  html += `</div></div>`;
});
  const tips = lang === 'en' ? [
    "Warm up well before each workout (5-10 minutes).",
    "Choose weights with which you can barely manage the last repetition of your last set.",
    "Execute each exercise in a controlled manner and focus on the working muscle.",
    "Normal training days, 2-3 sets, 8-12 repetitions for optimal muscle growth.",
    "On special strength training 2-3 sets, 6-8 repetitions for optimal development.",
    "Pause for 1-3 minutes between sets so that the pulse and muscles can recover",
    "Increase the weights once you have overcome the repetition limit.",
    "Make sure you recover sufficiently between training sessions."
  ] : [
    "Wärme dich vor jedem Training gut auf (5-10 Minuten).",
    "Wähle Gewichte, mit denen du die letzte Wiederholung beim letzten Set gerade noch schaffst.",
    "Führe jede Übung kontrolliert aus und konzentriere dich auf den arbeitenden Muskel.",
    "An normalen Tagen 2-3 Sätze, 8-12 Wiederholungen für optimales Muskelwachstum",
    "Bei Stärketraining 2-3 Sätze, 6-8 Wiederholungen für optimale Entwicklung",
    "Pausiere für 1-3 Minuten zwischen den Sets damit der Puls und die Muskeln sich erholen.",
    "Erhöhe die Gewichte, sobald du das Wiederholungslimit überschreiten kannst.",
    "Achte auf ausreichende Erholung zwischen den Trainingseinheiten."
  ];
  const tipsHtml = tips.map(tip => `<li>${tip}</li>`).join('');
  html += `
    </div>
    <div class="tips gradient-border">
      <h4>${trainingTipsText}:</h4>
      <ul style="margin-left:20px;margin-top:10px;">
        ${tipsHtml}
      </ul>
    </div>
    <div class="time-info" style="margin-top:15px;font-style:italic;">
      <p></p>
    </div>
  </div>
  `;

  container.innerHTML = html;
plan.forEach(d => {
  d.exercises.forEach((ex, i) => {
    const tipId = `tooltip-${d.day}-${i}`;
    const logId = `log-plan-${d.day}-${ex.id}`;
    const cardSel = `#exercise-${d.day}-${i}`;

    const tipEl    = document.getElementById(tipId);
    const logEl    = document.getElementById(logId);
    const detailBtn= document.querySelector(`${cardSel} .detail-btn[data-tooltip-id="${tipId}"]`);
    const logBtn   = document.querySelector(`${cardSel} .log-btn[data-log-id="${logId}"]`);

    if (detailBtn && tipEl) {
      detailBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        safeToggle(tipEl, logEl);
      });
    }
    if (logBtn && logEl) {
  logBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    safeToggle(logEl, tipEl);
    refreshLogPanels(getLogKey(ex)); // live anzeigen
  });
}

    // Gemeinsamer Key, damit Plan- und Listen-Ansicht dieselben Werte sehen
    attachLogHandlers(logId, getLogKey(ex));
  });
});

  const element = document.getElementById("outputdiv");
  if (element && isMobileView() && new_plan) {
    new_plan = false;
      const rect = element.getBoundingClientRect();
      const offset = 50;
      window.scrollTo({
          top: rect.top + window.scrollY - offset,
          behavior: "smooth"
      });
  }
}


function shuffleExercise(dayIndex, exerciseIndex, muscleGroup, equipment) {
    const day = plan.find(d => d.day === dayIndex);
    if (!day) return;

    const currentExercise = day.exercises[exerciseIndex];

    const usedExerciseIds = new Set(
    day.exercises
      .filter((ex, i) => i !== exerciseIndex)
      .map(ex => ex.id)
  );

    // Schritt 1: Covered prime muscles berechnen
    const primeMusclesCovered = new Set();
    day.exercises.forEach((ex, i) => {
        if (i !== exerciseIndex && ex.primeMuscle) {
            ex.primeMuscle.forEach(m => primeMusclesCovered.add(m));
        }
    });

    // Schritt 2: Overlap check Funktion
    const checkOverlap = (exercise) => {
        const primeMuscles = exercise.primeMuscle || [];
        if (primeMuscles.length === 0) return false;

        const newMuscles = primeMuscles.filter(m => !primeMusclesCovered.has(m));
        const overlapRatio = (primeMuscles.length - newMuscles.length) / primeMuscles.length;

        return overlapRatio > 0.7 && newMuscles.length <= 1;
    };

    // Schritt 3: Filter mit Overlap-Vermeidung
    let alternatives = exercises.filter(ex =>
        ex.muscleGroup === muscleGroup &&
        availableEquipment.includes(ex.equipment) &&
        ex.favorit !== -1 &&
        ex.id !== currentExercise.id &&
        !usedExerciseIds.has(ex.id) &&
        !checkOverlap(ex)
    );

    // Schritt 4: Wenn keine gefunden, dann ohne Overlap-Filter
    if (alternatives.length === 0) {
        alternatives = exercises.filter(ex =>
            ex.muscleGroup === muscleGroup &&
            availableEquipment.includes(ex.equipment) &&
            ex.favorit !== -1 &&
            ex.id !== currentExercise.id &&
            !usedExerciseIds.has(ex.id)
        );
    }

    // Schritt 5: Wenn noch immer keine, Fallback nur mit exakt gleichem Equipment
    if (alternatives.length === 0) {
        alternatives = exercises.filter(ex =>
            ex.muscleGroup === muscleGroup &&
            ex.equipment === equipment &&
            ex.favorit !== -1 &&
            ex.id !== currentExercise.id &&
            !usedExerciseIds.has(ex.id)
        );
    }

    // Schritt 6: Sortiere und wähle aus den Top 3 zufällig
    alternatives.sort((a, b) => b.effectiveness - a.effectiveness);
    const topAlternatives = alternatives.slice(0, Math.min(3, alternatives.length));
    const randomIndex = Math.floor(Math.random() * topAlternatives.length);
    const newExercise = topAlternatives[randomIndex];

    if (newExercise) {
        day.exercises[exerciseIndex] = newExercise;
        usedExerciseIds.delete(currentExercise.id);
        usedExerciseIds.add(newExercise.id);
        savePlan();
        renderTrainingPlan(plan, plan.length);
    } else {
        console.log("No alternative exercise found for this muscle group and equipment.");
    }
}


function toggleTheme() {
const html = document.documentElement;
const currentTheme = html.getAttribute('data-theme');
const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
html.setAttribute('data-theme', newTheme);
localStorage.setItem('theme', newTheme);
const toggleBtn = document.getElementById('toggleMode');
toggleBtn.textContent = `${newTheme === 'dark' ? 'Light mode' : 'Dark mode'}`;
//setCookie('preferredMode', newTheme, 365);
}

document.getElementById('daysValue').textContent = parseInt(document.getElementById('daysRange').value) + (lang === 'en' ? " days" : " Tage");
//toggleGender();
</script>
</body>
</html>
